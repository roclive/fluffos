<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ğŸ¤– AI-Agent + LLM - MUD æ™ºèƒ½æ¢ç´¢</title>
    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body { 
            background-color: #0d1117; 
            color: #c9d1d9; 
            font-family: 'JetBrains Mono', 'Consolas', monospace; 
            height: 100vh;
            display: flex;
            overflow: hidden;
        }
        
        /* ========== å·¦ä¾§ï¼šæ§åˆ¶é¢æ¿ ========== */
        #control-panel {
            width: 400px;
            background: #161b22;
            border-right: 1px solid #30363d;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        #panel-header {
            background: #21262d;
            padding: 15px;
            border-bottom: 1px solid #30363d;
        }
        
        #panel-header h1 {
            font-size: 16px;
            color: #58a6ff;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #panel-content {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
        }
        
        .section {
            background: #0d1117;
            border: 1px solid #30363d;
            border-radius: 6px;
            margin-bottom: 15px;
            overflow: hidden;
        }
        
        .section-header {
            background: #21262d;
            padding: 10px 12px;
            font-size: 12px;
            font-weight: bold;
            color: #8b949e;
            border-bottom: 1px solid #30363d;
        }
        
        .section-content {
            padding: 12px;
        }
        
        /* LLM é…ç½® */
        .llm-config-row {
            margin-bottom: 10px;
        }
        
        .llm-config-row label {
            display: block;
            font-size: 11px;
            color: #8b949e;
            margin-bottom: 4px;
        }
        
        .llm-config-row input,
        .llm-config-row select,
        .llm-config-row textarea {
            width: 100%;
            background: #21262d;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 8px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 12px;
        }
        
        .llm-config-row input:focus,
        .llm-config-row select:focus,
        .llm-config-row textarea:focus {
            outline: none;
            border-color: #58a6ff;
        }
        
        .llm-config-row textarea {
            resize: vertical;
            min-height: 60px;
        }
        
        /* æŒ‰é’® */
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            font-weight: bold;
            transition: all 0.2s;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-primary {
            background: #1f6feb;
            color: white;
        }
        
        .btn-primary:hover:not(:disabled) {
            background: #388bfd;
        }
        
        .btn-success {
            background: #238636;
            color: white;
        }
        
        .btn-success:hover:not(:disabled) {
            background: #2ea043;
        }
        
        .btn-danger {
            background: #da3633;
            color: white;
        }
        
        /* çŠ¶æ€æŒ‡ç¤º */
        .status-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #da3633;
        }
        
        .status-dot.connected { background: #3fb950; }
        .status-dot.thinking { 
            background: #58a6ff; 
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.3; }
        }
        
        /* æ™ºèƒ½æ—¥å¿— */
        #llm-log {
            max-height: 250px;
            overflow-y: auto;
            font-size: 11px;
            line-height: 1.5;
        }
        
        .log-entry {
            padding: 6px 8px;
            border-bottom: 1px solid #21262d;
            display: flex;
            gap: 8px;
        }
        
        .log-entry:last-child {
            border-bottom: none;
        }
        
        .log-time {
            color: #484f58;
            font-size: 10px;
            white-space: nowrap;
        }
        
        .log-type {
            font-size: 10px;
            padding: 1px 4px;
            border-radius: 3px;
            white-space: nowrap;
        }
        
        .log-type.system { 
            background: #21262d; 
            color: #8b949e;
        }
        
        .log-type.perception { 
            background: #d2992233; 
            color: #d29922;
        }
        
        .log-type.thought { 
            background: #58a6ff33; 
            color: #58a6ff;
        }
        
        .log-type.action { 
            background: #23863633; 
            color: #3fb950;
        }
        
        .log-type.llm { 
            background: #a371f733; 
            color: #a371f7;
        }
        
        .log-content {
            flex: 1;
            color: #c9d1d9;
        }
        
        /* ========== å³ä¾§ï¼šMUD è¾“å‡º ========== */
        #mud-panel {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
        }
        
        #mud-toolbar {
            background: #161b22;
            padding: 10px 15px;
            border-bottom: 1px solid #30363d;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .toolbar-input {
            background: #0d1117;
            border: 1px solid #30363d;
            color: #c9d1d9;
            padding: 6px 10px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 12px;
        }
        
        .toolbar-input:focus {
            outline: none;
            border-color: #58a6ff;
        }
        
        #mud-output {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            font-size: 14px;
            line-height: 1.5;
        }
        
        #mud-input-area {
            display: flex;
            padding: 12px 15px;
            background: #161b22;
            border-top: 1px solid #30363d;
            gap: 10px;
        }
        
        #mud-input {
            flex: 1;
            background: #0d1117;
            border: 1px solid #30363d;
            color: #3fb950;
            padding: 10px 12px;
            border-radius: 4px;
            font-family: inherit;
            font-size: 14px;
        }
        
        #mud-input:focus {
            outline: none;
            border-color: #238636;
        }
        
        #mud-input.llm-mode {
            border-color: #a371f7;
            background: #a371f711;
        }
        
        /* ANSI é¢œè‰² */
        .ansi-31 { color: #ff5555; }
        .ansi-32 { color: #3fb950; }
        .ansi-33 { color: #d29922; }
        .ansi-34 { color: #58a6ff; }
        .ansi-35 { color: #f778ba; }
        .ansi-36 { color: #39c5cf; }
        .ansi-37 { color: #ffffff; }
        .ansi-1 { font-weight: bold; }
        
        .mud-line {
            margin-bottom: 2px;
        }
        
        /* æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }
        
        ::-webkit-scrollbar-track {
            background: #0d1117;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #30363d;
            border-radius: 3px;
        }
        
        /* Token ç»Ÿè®¡ */
        .token-stats {
            display: flex;
            gap: 15px;
            font-size: 10px;
            color: #8b949e;
            padding-top: 8px;
            border-top: 1px solid #30363d;
            margin-top: 8px;
        }
        
        .token-stat {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .token-value {
            color: #58a6ff;
            font-weight: bold;
        }
    </style>
</head>
<body>

<!-- ========== å·¦ä¾§ï¼šæ§åˆ¶é¢æ¿ ========== -->
<div id="control-panel">
    <div id="panel-header">
        <h1>ğŸ¤– AI-Agent + LLM</h1>
    </div>
    
    <div id="panel-content">
        <!-- LLM é…ç½® -->
        <div class="section">
            <div class="section-header">
                ğŸ”‘ LLM API é…ç½®
            </div>
            <div class="section-content">
                <div class="llm-config-row">
                    <label>API ç±»å‹</label>
                    <select id="llm-provider">
                        <option value="openai">OpenAI (GPT-4/GPT-3.5)</option>
                        <option value="anthropic">Anthropic (Claude)</option>
                        <option value="custom">è‡ªå®šä¹‰ API</option>
                    </select>
                </div>
                
                <div class="llm-config-row">
                    <label>API Key</label>
                    <input type="password" id="llm-apikey" placeholder="sk-... æˆ– your-api-key">
                </div>
                
                <div class="llm-config-row">
                    <label>æ¨¡å‹</label>
                    <select id="llm-model">
                        <option value="gpt-4">GPT-4</option>
                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                        <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                        <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                        <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                    </select>
                </div>
                
                <div class="llm-config-row">
                    <label>API ç«¯ç‚¹ (å¯é€‰)</label>
                    <input type="text" id="llm-endpoint" placeholder="https://api.openai.com/v1/chat/completions">
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 10px;">
                    <button class="btn btn-primary" onclick="testLLM()" style="flex: 1;">
                        ğŸ§ª æµ‹è¯•è¿æ¥
                    </button>
                    <button class="btn btn-success" onclick="saveLLMConfig()" style="flex: 1;">
                        ğŸ’¾ ä¿å­˜
                    </button>
                </div>
            </div>
        </div>
        
        <!-- AI è§’è‰²è®¾å®š -->
        <div class="section">
            <div class="section-header">
                ğŸ­ AI è§’è‰²è®¾å®š (System Prompt)
            </div>
            <div class="section-content">
                <div class="llm-config-row">
                    <textarea id="system-prompt" placeholder="è¾“å…¥ System Prompt æ¥å®šä¹‰ AI çš„è¡Œä¸ºæ–¹å¼...">ä½ æ˜¯é‡‘åº¸æ­¦ä¾ ä¸–ç•Œ MUD æ¸¸æˆä¸­çš„ä¸€åä¾ å®¢ã€‚ä½ çš„ä»»åŠ¡æ˜¯åœ¨æ¸¸æˆä¸­ç”Ÿå­˜ã€æˆé•¿ã€æ¢ç´¢ä¸–ç•Œã€‚

å¯ç”¨å‘½ä»¤ï¼š
- ç§»åŠ¨: north, south, east, west, up, down (æˆ– n, s, e, w, u, d)
- æŸ¥çœ‹: look, hp, skills, inventory
- äº’åŠ¨: fight [target], perform [skill], exert [skill]
- å…¶ä»–: say, chat, tell ç­‰ç¤¾äº¤å‘½ä»¤

å†³ç­–åŸåˆ™ï¼š
1. ä¿æŒè§’è‰²ç”Ÿå­˜ï¼Œè¡€é‡ä½äº30%æ—¶ä¼˜å…ˆæ¢å¤
2. æ¢ç´¢æœªçŸ¥åŒºåŸŸï¼Œè®°å½•åœ°å›¾
3. é‡åˆ°æ•Œäººæ ¹æ®å®åŠ›åˆ¤æ–­æˆ˜æ–—æˆ–é€ƒè·‘
4. ä½¿ç”¨ perform jingmo ç­‰æŠ€èƒ½å¢å¼ºæˆ˜æ–—åŠ›
5. ä¸äººç±»ç©å®¶å‹å¥½äº’åŠ¨

è¯·æ ¹æ®å½“å‰æ¸¸æˆçŠ¶æ€ï¼Œç»™å‡ºä¸‹ä¸€æ­¥æœ€ä½³è¡ŒåŠ¨ã€‚</textarea>
                </div>
            </div>
        </div>
        
        <!-- è¿æ¥æ§åˆ¶ -->
        <div class="section">
            <div class="section-header">
                ğŸ® MUD è¿æ¥æ§åˆ¶
            </div>
            <div class="section-content">
                <div class="llm-config-row">
                    <label>æœåŠ¡å™¨</label>
                    <input type="text" id="mud-host" value="127.0.0.1:8080">
                </div>
                
                <div class="llm-config-row">
                    <label>è´¦å·</label>
                    <input type="text" id="mud-username" value="john">
                </div>
                
                <div class="llm-config-row">
                    <label>å¯†ç </label>
                    <input type="password" id="mud-password">
                </div>
                
                <div class="status-row" style="margin-top: 10px;">
                    <div id="mud-status" class="status-dot"></div>
                    <span id="mud-status-text">æœªè¿æ¥</span>
                </div>
                
                <div style="display: flex; gap: 8px; margin-top: 10px;">
                    <button class="btn btn-primary" id="btn-mud-connect" onclick="toggleMUDConnection()" style="flex: 1;">
                        ğŸ”Œ è¿æ¥
                    </button>
                    <button class="btn btn-success" id="btn-ai-start" onclick="toggleAI()" style="flex: 1;" disabled>
                        â–¶ï¸ å¯åŠ¨ AI
                    </button>
                </div>
            </div>
        </div>
        
        <!-- AI çŠ¶æ€ -->
        <div class="section">
            <div class="section-header">
                ğŸ“Š AI çŠ¶æ€
            </div>
            <div class="section-content">
                <div class="status-row">
                    <div id="ai-status" class="status-dot"></div>
                    <span id="ai-status-text">å¾…æœº</span>
                </div>
                
                <div style="font-size: 11px; color: #8b949e; margin-top: 8px;">
                    <div>ä½ç½®: <span id="ai-location" style="color: #58a6ff;">æœªçŸ¥</span></div>
                    <div style="margin-top: 4px;">è¡€é‡: <span id="ai-hp" style="color: #3fb950;">--</span></div>
                    <div style="margin-top: 4px;">å†…åŠ›: <span id="ai-neili" style="color: #58a6ff;">--</span></div>
                </div>
                
                <div class="token-stats">
                    <div class="token-stat">
                        <span>è¾“å…¥:</span>
                        <span class="token-value" id="tokens-in">0</span>
                    </div>
                    <div class="token-stat">
                        <span>è¾“å‡º:</span>
                        <span class="token-value" id="tokens-out">0</span>
                    </div>
                    <div class="token-stat">
                        <span>APIè°ƒç”¨:</span>
                        <span class="token-value" id="api-calls">0</span>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- LLM å†³ç­–æ—¥å¿— -->
        <div class="section">
            <div class="section-header">
                ğŸ’­ LLM å†³ç­–æ—¥å¿—
            </div>
            <div class="section-content" style="padding: 0;">
                <div id="llm-log">
                    <div class="log-entry">
                        <span class="log-time">--:--</span>
                        <span class="log-type system">ç³»ç»Ÿ</span>
                        <span class="log-content">ç­‰å¾…é…ç½® LLM API...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- ========== å³ä¾§ï¼šMUD è¾“å‡º ========== -->
<div id="mud-panel">
    <div id="mud-toolbar">
        <input type="text" class="toolbar-input" value="LLM-Powered MUD AI Agent" readonly style="flex: 1; background: #21262d;">
        <button class="btn btn-primary" onclick="clearLog()">ğŸ—‘ï¸ æ¸…å±</button>
    </div>
    
    <div id="mud-output">
        <div style="color: #a371f7;">
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘              ğŸ¤– LLM-Powered MUD AI Agent                         â•‘
â•‘              æ™ºèƒ½ä½“ + å¤§è¯­è¨€æ¨¡å‹                                  â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
        </div>
        <div style="margin-top: 10px;">
ä½¿ç”¨è¯´æ˜ï¼š

1. ğŸ”‘ é…ç½® LLM API
   - é€‰æ‹© API æä¾›å•† (OpenAI / Anthropic)
   - è¾“å…¥ API Key
   - é€‰æ‹©æ¨¡å‹ (æ¨è Claude 3 Sonnet)
   - ç‚¹å‡»"æµ‹è¯•è¿æ¥"éªŒè¯

2. ğŸ­ é…ç½® AI è§’è‰² (å¯é€‰)
   - ä¿®æ”¹ System Prompt å®šä¹‰ AI è¡Œä¸º
   - é¢„è®¾äº†é‡‘åº¸ MUD æ¸¸æˆè§’è‰²è®¾å®š

3. ğŸ”Œ è¿æ¥ MUD æœåŠ¡å™¨
   - è¾“å…¥æœåŠ¡å™¨åœ°å€ã€è´¦å·ã€å¯†ç 
   - ç‚¹å‡»"è¿æ¥"

4. â–¶ï¸ å¯åŠ¨ AI
   - AI ä¼šè‡ªä¸»è§‚å¯Ÿæ¸¸æˆçŠ¶æ€
   - æ¯å›åˆè°ƒç”¨ LLM åšå†³ç­–
   - æ‰§è¡Œå‘½ä»¤å¹¶è§‚å¯Ÿç»“æœ
   - å¾ªç¯å¾€å¤

ç‰¹ç‚¹ï¼š
â€¢ æ¯æ¬¡å†³ç­–éƒ½è°ƒç”¨ LLMï¼ŒçœŸæ­£çš„æ™ºèƒ½
â€¢ AI ä¼šè§£é‡Šè‡ªå·±çš„æ€è€ƒè¿‡ç¨‹
â€¢ æ”¯æŒä¸Šä¸‹æ–‡è®°å¿†
â€¢ è‡ªåŠ¨ token ç»Ÿè®¡

âš ï¸ æ³¨æ„ï¼šé¢‘ç¹è°ƒç”¨ API ä¼šäº§ç”Ÿè´¹ç”¨ï¼Œè¯·åˆç†è®¾ç½®æ€è€ƒé—´éš”ã€‚
        </div>
    </div>
    
    <div id="mud-input-area">
        <input type="text" id="mud-input" placeholder="è¾“å…¥å‘½ä»¤...">
    </div>
</div>

<script>
// ==================== LLM AI Agent ====================

class LLMAgent {
    constructor() {
        // MUD è¿æ¥
        this.ws = null;
        this.connected = false;
        this.authenticated = false;
        
        // AI çŠ¶æ€
        this.running = false;
        this.thinking = false;
        
        // æ¸¸æˆçŠ¶æ€
        this.gameState = {
            hp: 0, maxHp: 0,
            neili: 0, maxNeili: 0,
            jingli: 0, maxJingli: 0,
            exp: 0,
            location: 'æœªçŸ¥',
            exits: [],
            inventory: [],
            inCombat: false,
            lastOutput: '',
            outputHistory: []
        };
        
        // LLM é…ç½®
        this.llmConfig = {
            provider: 'openai',
            apiKey: '',
            model: 'gpt-3.5-turbo',
            endpoint: '',
            systemPrompt: ''
        };
        
        // ç»Ÿè®¡
        this.stats = {
            tokensIn: 0,
            tokensOut: 0,
            apiCalls: 0
        };
        
        // ä¸Šä¸‹æ–‡è®°å¿†
        this.context = [];
        this.maxContext = 10;
        
        // å†³ç­–é—´éš”
        this.decisionInterval = 5000; // 5ç§’
        this.timer = null;
    }
    
    // ========== LLM API è°ƒç”¨ ==========
    
    async callLLM(prompt, temperature = 0.7) {
        const provider = document.getElementById('llm-provider').value;
        const apiKey = document.getElementById('llm-apikey').value;
        const model = document.getElementById('llm-model').value;
        const endpoint = document.getElementById('llm-endpoint').value;
        const systemPrompt = document.getElementById('system-prompt').value;
        
        if (!apiKey) {
            throw new Error('æœªé…ç½® API Key');
        }
        
        this.log('æ­£åœ¨è°ƒç”¨ LLM...', 'llm');
        this.setThinking(true);
        
        try {
            let response;
            
            if (provider === 'openai' || provider === 'custom') {
                response = await this.callOpenAI(apiKey, model, endpoint, systemPrompt, prompt, temperature);
            } else if (provider === 'anthropic') {
                response = await this.callAnthropic(apiKey, model, systemPrompt, prompt, temperature);
            }
            
            this.stats.apiCalls++;
            updateStats();
            this.setThinking(false);
            
            return response;
        } catch (error) {
            this.setThinking(false);
            throw error;
        }
    }
    
    async callOpenAI(apiKey, model, endpoint, systemPrompt, prompt, temperature) {
        const url = endpoint || 'https://api.openai.com/v1/chat/completions';
        
        const messages = [
            { role: 'system', content: systemPrompt },
            ...this.context,
            { role: 'user', content: prompt }
        ];
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${apiKey}`
            },
            body: JSON.stringify({
                model: model,
                messages: messages,
                temperature: temperature,
                max_tokens: 150
            })
        });
        
        if (!response.ok) {
            const error = await response.text();
            throw new Error(`API Error: ${error}`);
        }
        
        const data = await response.json();
        
        // æ›´æ–° token ç»Ÿè®¡
        this.stats.tokensIn += data.usage?.prompt_tokens || 0;
        this.stats.tokensOut += data.usage?.completion_tokens || 0;
        
        return {
            content: data.choices[0].message.content,
            usage: data.usage
        };
    }
    
    async callAnthropic(apiKey, model, systemPrompt, prompt, temperature) {
        const url = 'https://api.anthropic.com/v1/messages';
        
        const messages = [
            ...this.context,
            { role: 'user', content: prompt }
        ];
        
        const response = await fetch(url, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'x-api-key': apiKey,
                'anthropic-version': '2023-06-01'
            },
            body: JSON.stringify({
                model: model,
                max_tokens: 150,
                temperature: temperature,
                system: systemPrompt,
                messages: messages
            })
        });
        
        if (!response.ok) {
            const error = await response.text();
            throw new Error(`API Error: ${error}`);
        }
        
        const data = await response.json();
        
        // æ›´æ–° token ç»Ÿè®¡ (Anthropic æ ¼å¼ä¸åŒ)
        this.stats.tokensIn += data.usage?.input_tokens || 0;
        this.stats.tokensOut += data.usage?.output_tokens || 0;
        
        return {
            content: data.content[0].text,
            usage: data.usage
        };
    }
    
    // ========== MUD è¿æ¥ ==========
    
    connect(host, username, password) {
        return new Promise((resolve, reject) => {
            const wsUri = `ws://${host}`;
            
            this.log(`è¿æ¥ MUD: ${wsUri}`, 'system');
            
            this.ws = new WebSocket(wsUri, "ascii");
            this.ws.binaryType = "arraybuffer";
            
            this.ws.onopen = () => {
                this.log("âœ… WebSocket è¿æ¥æˆåŠŸ", 'system');
                this.connected = true;
                updateMUDStatus(true);
                
                // è‡ªåŠ¨ç™»å½•
                setTimeout(() => this.send(username), 500);
                if (password) {
                    setTimeout(() => this.send(password), 1500);
                }
                
                setTimeout(() => resolve(), 2000);
            };
            
            this.ws.onclose = () => {
                this.log("âŒ è¿æ¥æ–­å¼€", 'system');
                this.stop();
                this.connected = false;
                this.authenticated = false;
                updateMUDStatus(false);
                updateAIStatus('offline');
            };
            
            this.ws.onmessage = (evt) => {
                let text;
                if (evt.data instanceof ArrayBuffer) {
                    text = new TextDecoder("utf-8").decode(evt.data);
                } else {
                    text = evt.data;
                }
                
                this.processGameOutput(text);
                writeToMUD(text);
            };
            
            this.ws.onerror = (err) => {
                this.log("âš ï¸ è¿æ¥é”™è¯¯", 'system');
                reject(err);
            };
        });
    }
    
    send(cmd) {
        if (this.ws && this.ws.readyState === WebSocket.OPEN) {
            this.ws.send(cmd + "\n");
            return true;
        }
        return false;
    }
    
    // ========== æ¸¸æˆçŠ¶æ€å¤„ç† ==========
    
    processGameOutput(text) {
        // ä¿å­˜åˆ°å†å²
        this.gameState.outputHistory.push(text);
        if (this.gameState.outputHistory.length > 20) {
            this.gameState.outputHistory.shift();
        }
        
        this.gameState.lastOutput = text;
        
        // è§£æçŠ¶æ€
        this.parseStatus(text);
        
        // æ£€æµ‹ç™»å½•æˆåŠŸ
        if (!this.authenticated && 
            (text.includes("æ¬¢è¿") || text.includes("ä½ å¥½") || text.includes("ä»Šæ—¥æ˜¯"))) {
            this.authenticated = true;
            this.log("ğŸ‰ ç™»å½•æˆåŠŸï¼å¯ä»¥å¯åŠ¨ AI", 'system');
            updateAIStatus('ready');
            document.getElementById('btn-ai-start').disabled = false;
        }
        
        // æ·»åŠ åˆ°ä¸Šä¸‹æ–‡
        if (this.running && text.length > 10) {
            this.addToContext('assistant', `æ¸¸æˆè¾“å‡º: ${text.substring(0, 500)}`);
        }
    }
    
    parseStatus(text) {
        const hpMatch = text.match(/(?:ç²¾|æ°”è¡€).*?(\d+)\s*\/\s*(\d+)/i);
        if (hpMatch) {
            this.gameState.hp = parseInt(hpMatch[1]);
            this.gameState.maxHp = parseInt(hpMatch[2]);
            document.getElementById('ai-hp').textContent = `${this.gameState.hp}/${this.gameState.maxHp}`;
        }
        
        const neiliMatch = text.match(/(?:å†…åŠ›).*?(\d+)\s*\/\s*(\d+)/i);
        if (neiliMatch) {
            this.gameState.neili = parseInt(neiliMatch[1]);
            this.gameState.maxNeili = parseInt(neiliMatch[2]);
            document.getElementById('ai-neili').textContent = `${this.gameState.neili}/${this.gameState.maxNeili}`;
        }
        
        const roomMatch = text.match(/^\s*([^\n]+?)\s*[-ï¼]/);
        if (roomMatch && text.length < 500) {
            const roomName = roomMatch[1].trim();
            if (roomName.length > 2 && roomName.length < 40) {
                this.gameState.location = roomName;
                document.getElementById('ai-location').textContent = roomName;
            }
        }
    }
    
    addToContext(role, content) {
        this.context.push({ role, content });
        if (this.context.length > this.maxContext) {
            this.context.shift();
        }
    }
    
    // ========== AI å†³ç­–å¾ªç¯ ==========
    
    async start() {
        if (!this.connected || !this.authenticated) {
            this.log("âŒ è¯·å…ˆè¿æ¥ MUD", 'system');
            return;
        }
        
        this.running = true;
        updateAIStatus('running');
        document.getElementById('mud-input').classList.add('llm-mode');
        
        this.log("ğŸš€ AI å¯åŠ¨ï¼å¼€å§‹ LLM é©±åŠ¨æ¢ç´¢...", 'system');
        
        // åˆå§‹è§‚å¯Ÿ
        this.send("look");
        await this.sleep(1000);
        this.send("hp");
        await this.sleep(1000);
        
        // å¼€å§‹å†³ç­–å¾ªç¯
        this.decisionLoop();
    }
    
    stop() {
        this.running = false;
        if (this.timer) {
            clearTimeout(this.timer);
        }
        document.getElementById('mud-input').classList.remove('llm-mode');
        updateAIStatus('ready');
        this.log("â¹ï¸ AI å·²åœæ­¢", 'system');
    }
    
    async decisionLoop() {
        while (this.running && this.connected) {
            try {
                await this.makeDecision();
            } catch (error) {
                this.log(`å†³ç­–é”™è¯¯: ${error.message}`, 'system');
            }
            
            await this.sleep(this.decisionInterval);
        }
    }
    
    async makeDecision() {
        // æ„å»ºæç¤ºè¯
        const prompt = this.buildPrompt();
        
        this.log("æ€è€ƒä¸­...", 'thought');
        
        try {
            // è°ƒç”¨ LLM
            const response = await this.callLLM(prompt);
            const decision = response.content.trim();
            
            this.log(`LLM: ${decision}`, 'llm');
            
            // è§£æå†³ç­–
            const action = this.parseDecision(decision);
            
            if (action) {
                this.log(`æ‰§è¡Œ: ${action}`, 'action');
                this.send(action);
                this.addToContext('assistant', `æˆ‘å†³å®šæ‰§è¡Œ: ${action}`);
            }
        } catch (error) {
            this.log(`API é”™è¯¯: ${error.message}`, 'system');
        }
    }
    
    buildPrompt() {
        const state = this.gameState;
        const hpPercent = state.maxHp > 0 ? (state.hp / state.maxHp * 100).toFixed(1) : 0;
        
        return `å½“å‰æ¸¸æˆçŠ¶æ€ï¼š
- ä½ç½®: ${state.location}
- è¡€é‡: ${state.hp}/${state.maxHp} (${hpPercent}%)
- å†…åŠ›: ${state.neili}/${state.maxNeili}
- æœ€è¿‘è¾“å‡º: ${state.lastOutput.substring(0, 300)}

è¯·ç»™å‡ºä¸‹ä¸€æ­¥è¡ŒåŠ¨ï¼Œåªè¿”å›å‘½ä»¤æœ¬èº«ï¼Œä¸è¦è§£é‡Šã€‚
ä¾‹å¦‚: north, look, fight xiaoer, perform jingmo`;
    }
    
    parseDecision(decision) {
        // æ¸…ç†å†³ç­–æ–‡æœ¬ï¼Œæå–å‘½ä»¤
        const lines = decision.split('\n');
        for (const line of lines) {
            const trimmed = line.trim();
            // è·³è¿‡ç©ºè¡Œå’Œè§£é‡Š
            if (!trimmed || trimmed.startsWith('//') || trimmed.length > 50) continue;
            
            // æå–å‘½ä»¤ï¼ˆé€šå¸¸æ˜¯ç¬¬ä¸€è¡Œéç©ºå†…å®¹ï¼‰
            const cmd = trimmed.toLowerCase();
            
            // éªŒè¯æ˜¯åˆæ³•å‘½ä»¤
            const validCmds = ['north', 'south', 'east', 'west', 'up', 'down', 
                             'n', 's', 'e', 'w', 'u', 'd',
                             'look', 'l', 'hp', 'skills', 'i', 'inventory',
                             'fight', 'perform', 'exert', 'say', 'chat'];
            
            if (validCmds.some(vc => cmd.includes(vc))) {
                return trimmed;
            }
        }
        
        return 'look'; // é»˜è®¤å‘½ä»¤
    }
    
    // ========== è¾…åŠ©æ–¹æ³• ==========
    
    sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    log(message, type = 'system') {
        const logDiv = document.getElementById('llm-log');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerHTML = `
            <span class="log-time">${new Date().toLocaleTimeString()}</span>
            <span class="log-type ${type}">${type.toUpperCase()}</span>
            <span class="log-content">${message}</span>
        `;
        logDiv.insertBefore(entry, logDiv.firstChild);
        
        while (logDiv.children.length > 50) {
            logDiv.removeChild(logDiv.lastChild);
        }
    }
    
    setThinking(thinking) {
        this.thinking = thinking;
        const dot = document.getElementById('ai-status');
        if (thinking) {
            dot.classList.add('thinking');
        } else {
            dot.classList.remove('thinking');
        }
    }
}

// ==================== UI æ§åˆ¶ ====================

const agent = new LLMAgent();

// æµ‹è¯• LLM è¿æ¥
async function testLLM() {
    agent.log("ğŸ§ª æµ‹è¯• LLM è¿æ¥...", 'system');
    
    try {
        const response = await agent.callLLM(
            "Hello, this is a test. Please respond with 'OK'.",
            0.1
        );
        
        agent.log(`âœ… è¿æ¥æˆåŠŸï¼å“åº”: ${response.content.substring(0, 50)}`, 'system');
        alert("LLM è¿æ¥æµ‹è¯•æˆåŠŸï¼");
    } catch (error) {
        agent.log(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'system');
        alert(`è¿æ¥å¤±è´¥: ${error.message}`);
    }
}

// ä¿å­˜é…ç½®
function saveLLMConfig() {
    const config = {
        provider: document.getElementById('llm-provider').value,
        apiKey: document.getElementById('llm-apikey').value,
        model: document.getElementById('llm-model').value,
        endpoint: document.getElementById('llm-endpoint').value,
        systemPrompt: document.getElementById('system-prompt').value
    };
    
    localStorage.setItem('llm-config', JSON.stringify(config));
    agent.log("ğŸ’¾ é…ç½®å·²ä¿å­˜", 'system');
    alert("é…ç½®å·²ä¿å­˜åˆ°æµè§ˆå™¨æœ¬åœ°å­˜å‚¨");
}

// åŠ è½½é…ç½®
function loadConfig() {
    const saved = localStorage.getItem('llm-config');
    if (saved) {
        const config = JSON.parse(saved);
        document.getElementById('llm-provider').value = config.provider || 'openai';
        document.getElementById('llm-apikey').value = config.apiKey || '';
        document.getElementById('llm-model').value = config.model || 'gpt-3.5-turbo';
        document.getElementById('llm-endpoint').value = config.endpoint || '';
        document.getElementById('system-prompt').value = config.systemPrompt || document.getElementById('system-prompt').value;
        agent.log("ğŸ“‚ å·²åŠ è½½ä¿å­˜çš„é…ç½®", 'system');
    }
}

// MUD è¿æ¥
async function toggleMUDConnection() {
    if (agent.connected) {
        agent.ws.close();
    } else {
        const host = document.getElementById('mud-host').value;
        const username = document.getElementById('mud-username').value;
        const password = document.getElementById('mud-password').value;
        
        if (!host || !username) {
            alert("è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€å’Œè´¦å·");
            return;
        }
        
        const btn = document.getElementById('btn-mud-connect');
        btn.disabled = true;
        btn.textContent = "è¿æ¥ä¸­...";
        
        try {
            await agent.connect(host, username, password);
        } catch (error) {
            alert(`è¿æ¥å¤±è´¥: ${error.message}`);
        } finally {
            btn.disabled = false;
            btn.textContent = agent.connected ? "ğŸ”Œ æ–­å¼€" : "ğŸ”Œ è¿æ¥";
        }
    }
}

// AI å¯åŠ¨/åœæ­¢
function toggleAI() {
    if (agent.running) {
        agent.stop();
        document.getElementById('btn-ai-start').textContent = "â–¶ï¸ å¯åŠ¨ AI";
        document.getElementById('btn-ai-start').className = "btn btn-success";
    } else {
        agent.start();
        document.getElementById('btn-ai-start').textContent = "â¹ï¸ åœæ­¢ AI";
        document.getElementById('btn-ai-start').className = "btn btn-danger";
    }
}

// æ›´æ–°çŠ¶æ€ UI
function updateMUDStatus(connected) {
    const dot = document.getElementById('mud-status');
    const text = document.getElementById('mud-status-text');
    const btn = document.getElementById('btn-mud-connect');
    
    if (connected) {
        dot.classList.add('connected');
        text.textContent = "å·²è¿æ¥";
        btn.textContent = "ğŸ”Œ æ–­å¼€";
    } else {
        dot.classList.remove('connected');
        text.textContent = "æœªè¿æ¥";
        btn.textContent = "ğŸ”Œ è¿æ¥";
        document.getElementById('btn-ai-start').disabled = true;
    }
}

function updateAIStatus(status) {
    const dot = document.getElementById('ai-status');
    const text = document.getElementById('ai-status-text');
    
    dot.className = 'status-dot';
    
    switch(status) {
        case 'running':
            dot.classList.add('thinking');
            text.textContent = "è¿è¡Œä¸­";
            break;
        case 'ready':
            dot.classList.add('connected');
            text.textContent = "å°±ç»ª";
            break;
        case 'offline':
        default:
            text.textContent = "å¾…æœº";
            break;
    }
}

function updateStats() {
    document.getElementById('tokens-in').textContent = agent.stats.tokensIn.toLocaleString();
    document.getElementById('tokens-out').textContent = agent.stats.tokensOut.toLocaleString();
    document.getElementById('api-calls').textContent = agent.stats.apiCalls.toLocaleString();
}

// MUD è¾“å‡º
function writeToMUD(text) {
    const output = document.getElementById('mud-output');
    
    let escaped = text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;");
    let openSpans = 0;
    let html = escaped.replace(/\x1B\[([0-9;]*)m/g, function(match, p1) {
        if (p1 === "" || p1 === "0") {
            const close = "</span>".repeat(openSpans);
            openSpans = 0;
            return close;
        }
        const classes = p1.split(';').map(c => 'ansi-' + c).join(' ');
        openSpans++;
        return '<span class="' + classes + '">';
    });
    if (openSpans > 0) {
        html += "</span>".repeat(openSpans);
    }
    
    const div = document.createElement('div');
    div.className = 'mud-line';
    div.innerHTML = html || text;
    output.appendChild(div);
    output.scrollTop = output.scrollHeight;
}

function clearLog() {
    document.getElementById('mud-output').innerHTML = '';
}

// è¾“å…¥ç›‘å¬
const input = document.getElementById('mud-input');
input.addEventListener('keydown', function(event) {
    if (event.key === 'Enter') {
        event.preventDefault();
        const msg = input.value.trim();
        if (msg) {
            agent.send(msg);
            input.value = '';
        }
    }
});

// åŠ è½½é…ç½®
window.onload = loadConfig;
</script>

</body>
</html>
